generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(uuid())
  clerkId            String             @unique
  email              String             @unique
  name               String
  phone              String?
  profilePhoto       String?
  password           String?            // For custom auth (without Clerk)
  verificationStatus VerificationStatus @default(PENDING)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  vehicles       Vehicle[]
  bookings       Booking[]
  wallet         Wallet?
  predictionLogs PredictionLog[]
}

model Vehicle {
  id                 String             @id @default(uuid())
  userId             String
  user               User               @relation(fields: [userId], references: [id])
  registrationNumber String             @unique
  ownerName          String
  enteredName        String
  make               String
  model              String
  color              String?
  fuelType           String?
  registrationDate   DateTime?
  qrCode             String?
  numberPlatePhoto   String?
  verificationStatus VerificationStatus
  verificationScore  Float?
  verificationMethod VerificationMethod
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  verificationLogs VerificationLog[]
  bookings         Booking[]
}

model VerificationLog {
  id           String             @id @default(uuid())
  vehicleId    String
  vehicle      Vehicle            @relation(fields: [vehicleId], references: [id])
  rtoResponse  Json
  enteredName  String
  rtoOwnerName String
  matchScore   Float
  method       VerificationMethod
  status       VerificationStatus
  createdAt    DateTime           @default(now())
}

model ParkingSpot {
  id                      String        @id @default(uuid())
  name                    String
  address                 String
  latitude                Float
  longitude               Float
  totalSpots              Int
  availableSpots          Int
  pricePerHour            Float
  isCovered               Boolean       @default(false)
  hasSecurity             Boolean       @default(false)
  hasEVCharging           Boolean       @default(false)
  rating                  Float         @default(0)
  imageUrl                String?
  entryCameraId           String?
  exitCameraId            String?
  hasALPR                 Boolean       @default(false)
  overtimePriceMultiplier Float         @default(1.5)
  isActive                Boolean       @default(true)
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  // Relations
  parkingAreaId           String?
  parkingArea             ParkingArea?  @relation(fields: [parkingAreaId], references: [id])
  
  bookings                Booking[]
  slots                   ParkingSlot[]
}

model ParkingSlot {
  id              String       @id @default(uuid())
  parkingSpotId   String
  parkingSpot     ParkingSpot  @relation(fields: [parkingSpotId], references: [id])
  slotNumber      Int
  cameraId        String?
  permanentSlotId String?      @unique
  status          SlotStatus   @default(FREE)
  lastUpdated     DateTime     @default(now())
  isActive        Boolean      @default(true)

  cvLogs          SlotCVLog[]
  bookings        Booking[]    // <- NEW: all bookings assigned to this slot
}


model SlotCVLog {
  id            String      @id @default(uuid())
  slotId        String
  slot          ParkingSlot @relation(fields: [slotId], references: [id])
  eventType     CVEventType
  detectedPlate String?
  confidence    Float?
  imageUrl      String?
  status        SlotStatus
  timestamp     DateTime     @default(now())
}

model Booking {
  id               String        @id @default(uuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id])
  vehicleId        String
  vehicle          Vehicle       @relation(fields: [vehicleId], references: [id])
  parkingSpotId    String
  parkingSpot      ParkingSpot   @relation(fields: [parkingSpotId], references: [id])
  parkingSlotId    String?       // <- NEW: optional relation to specific slot
  parkingSlot      ParkingSlot?  @relation(fields: [parkingSlotId], references: [id])

  bookedStartTime  DateTime
  bookedEndTime    DateTime
  bookedDuration   Int
  actualEntryTime  DateTime?
  actualExitTime   DateTime?
  actualDuration   Int?
  baseAmount       Float
  extraTimeAmount  Float         @default(0)
  totalAmount      Float
  paymentMode      PaymentMode
  paymentStatus    PaymentStatus
  paymentSource    String        @default("WALLET")
  status           BookingStatus
  entryQrCode      String?
  entryImageUrl    String?
  exitImageUrl     String?
  isOverstay       Boolean       @default(false)
  overstayMinutes  Int           @default(0)
  overstayCharged  Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  cvLogs CVLog[]
}

model CVLog {
  id               String      @id @default(uuid())
  bookingId        String?
  booking          Booking?    @relation(fields: [bookingId], references: [id])
  vehicleNumber    String
  eventType        CVEventType
  confidence       Float
  imageUrl         String?
  cameraId         String?
  timestamp        DateTime    @default(now())
  processed        Boolean     @default(false)
  processingError  String?
  createdAt        DateTime    @default(now())
}

model Wallet {
  id               String    @id @default(uuid())
  userId           String    @unique
  user             User      @relation(fields: [userId], references: [id])
  balance          Float     @default(0)
  lockedBalance    Float     @default(0)
  minBalance       Float     @default(50)
  maxBalance       Float     @default(10000)
  stripeCustomerId String?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  transactions Transaction[]
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String
  wallet          Wallet            @relation(fields: [walletId], references: [id])
  type            TransactionType
  amount          Float
  balanceBefore   Float
  balanceAfter    Float
  bookingId       String?
  stripePaymentId String?
  description     String
  status          TransactionStatus
  createdAt       DateTime          @default(now())
}

enum VerificationStatus {
  PENDING
  AUTO_VERIFIED
  MANUAL_REVIEW
  VERIFIED
  REJECTED
}

enum VerificationMethod {
  QR_SCAN
  MANUAL_ENTRY
  PHOTO_OCR
}

enum PaymentMode {
  PREPAID
  PAY_LATER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  OVERSTAY
  COMPLETED
  CANCELLED
}

enum CVEventType {
  ENTRY
  EXIT
  OVERSTAY_ALERT
  SLOT_UPDATE
}

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SlotStatus {
  FREE
  OCCUPIED
  BLOCKED
}

// New models for enhanced parking prediction system
model ParkingArea {
  id          String   @id @default(uuid())
  areaId      String   @unique // e.g., "main_gate", "sports_complex"
  name        String   // e.g., "Main Gate Parking"
  totalSlots  Int
  latitude    Float
  longitude   Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parkingSpots       ParkingSpot[]
  predictionLogs     PredictionLog[]
  occupancySnapshots OccupancySnapshot[]
}

model PredictionLog {
  id                   String      @id @default(uuid())
  userId               String
  user                 User        @relation(fields: [userId], references: [id])
  parkingAreaId        String
  parkingArea          ParkingArea @relation(fields: [parkingAreaId], references: [id])
  predictionType       PredictionType
  inputData            Json        // Store all input parameters
  predictedPercentage  Float       // Predicted availability percentage
  actualPercentage     Float?      // Actual availability (for accuracy tracking)
  confidence           String      // High, Medium, Low
  userLocation         Json        // {lat, lng}
  plannedArrivalTime   DateTime?
  actualArrivalTime    DateTime?
  modelVersion         String?     @default("1.0")
  isAccurate           Boolean?    // Whether prediction was accurate
  accuracyScore        Float?      // How close prediction was to actual
  weatherCondition     String?
  trafficDensity       Float?
  createdAt            DateTime    @default(now())
}

model OccupancySnapshot {
  id              String      @id @default(uuid())
  parkingAreaId   String
  parkingArea     ParkingArea @relation(fields: [parkingAreaId], references: [id])
  totalSlots      Int
  occupiedSlots   Int
  freeSlots       Int
  occupancyRate   Float       // Percentage
  timestamp       DateTime    @default(now())
  dataSource      String      @default("CV_SYSTEM") // CV_SYSTEM, MANUAL, SENSOR
  weatherCondition String?
  temperature     Float?
  trafficDensity  Float?
  isWeekend       Boolean     @default(false)
  isHoliday       Boolean     @default(false)
  eventNearby     Boolean     @default(false)
}

enum PredictionType {
  SPOT_AVAILABILITY
  AREA_RECOMMENDATION
}
